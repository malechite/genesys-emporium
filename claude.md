# Claude Code Session Notes

## Current Task: Get App Running - Convert to Yarn & Fix Build

### Session Status: In Progress
**Last Updated**: 2025-10-22

**Priority Change:** Pausing Firebase migration to get the app building and running first.

---

## Previous Work: Package Upgrades

### Background
VSCode crashed during previous session. We were working on fixing npm package warnings and upgrading libraries.

### Completed Work
- ‚úÖ Removed deprecated React addons from package.json:
  - `react-addons-css-transition-group`
  - `react-addons-transition-group`
- ‚úÖ Ran `npm audit fix --legacy-peer-deps`:
  - Fixed 48 vulnerabilities (140 ‚Üí 92)
  - Updated 200 packages, added 80, removed 52
  - Used --legacy-peer-deps due to react-firebaseui incompatibility with React 18

### Current State
- **Total Vulnerabilities**: 92 (7 low, 37 moderate, 42 high, 6 critical)
- **Modified Files**:
  - package.json (changes staged in git)
  - package-lock.json (changes staged in git)

### Major Outdated Dependencies (DEPRIORITIZED)
- Firebase: v7.14.3 ‚Üí **REMOVING instead of upgrading**
- Nx packages (@nrwl/*): v9.5.1 ‚Üí Can address after Firebase migration
- React: v18.3.1 ‚úÖ (already up to date)

### OLD Todo List (Package Upgrades - ON HOLD)
1. ‚úÖ **DONE**: Run `npm audit fix` for non-breaking changes
2. ‚ùå ~~Review and upgrade Firebase packages~~ ‚Üí **REMOVING FIREBASE**
3. üîú Address remaining high/critical vulnerabilities (after migration)
4. üîú Test the application after upgrades
5. üîú Consider Nx upgrade (after migration)

### Remaining Vulnerabilities (Require --force / Breaking Changes)
- **Critical (6)**: @cypress/request (cypress upgrade needed)
- **High (42)**:
  - rollup, semver, serialize-javascript, terser
  - webpack-dev-middleware, postcss, node-fetch
- **Moderate (37)**:
  - @firebase/util (firebase upgrade needed), sockjs, tough-cookie
  - tmp, yargs-parser, postcss-related packages

---

## NEW DIRECTION: Firebase to Custom Backend Migration

### Decision Rationale
- Firebase v7 has security vulnerabilities
- react-firebaseui incompatible with React 18
- Want to own the data layer and run on K8s with Postgres
- FeathersJS aligns with other projects in the portfolio

### Current Firebase Usage Analysis

**Firebase Features Used:**
- ‚úÖ **Firestore Database** - All data persistence (characters, user data, custom content)
- ‚úÖ **Firebase Authentication** - Google, Phone, Email, Anonymous auth
- ‚úÖ **Firebase Hosting** - Application deployment

**Key Files:**
- `packages/emporium/src/app/firestoreDB.js` - Firebase initialization
- `packages/emporium/src/redux/actions.tsx` - **ALL Firestore operations (410 lines)**
- `packages/emporium/src/app/components/User.tsx` - FirebaseUI auth component
- `packages/emporium/src/app/app.tsx` - Auth state listener

**Data Model:**
- `users/{userId}/data/characters/{characterId}/*` - Character data (18+ attribute types)
- `users/{userId}/data/characterList` - Character metadata
- `users/{userId}/data/settings` - User preferences
- `userDB/{userId}` - User profiles
- `*DB` collections - Custom content (10+ types: customArchetypes, customWeapons, etc.)

**Key Operations:**
- 40+ Firestore operations across codebase
- Extensive use of real-time listeners (`onSnapshot`)
- Complex queries with `.where()` clauses
- Batch operations for character deletion

### Migration Plan

#### **Phase 1: Backend Infrastructure Setup** ‚úÖ COMPLETED
Set up FeathersJS API with Postgres database to replace Firebase backend.

**Completed Tasks:**
1. ‚úÖ Created docker-compose.yml with Postgres 16
2. ‚úÖ Created .env and .env.example with database configuration
3. ‚úÖ Set up apps/api with FeathersJS v5
4. ‚úÖ Created TypeScript configuration for API
5. ‚úÖ Set up Knex for database migrations
6. ‚úÖ Created users and characters database tables
7. ‚úÖ Implemented basic CRUD services for users and characters
8. ‚úÖ API running successfully on http://localhost:3030
9. ‚úÖ Tested full CRUD operations and query filtering

**Infrastructure:**
- **Database**: Postgres 16 running in Docker (container: genesys-emporium-db)
- **API**: FeathersJS v5 with Koa, Socket.io, and REST
- **Dev Server**: tsx watch with hot-reload
- **ORM**: Knex v3.1.0 with TypeScript migrations

#### **Phase 2: Complete API Implementation** ‚úÖ COMPLETED
Created comprehensive FeathersJS API with all data types and operations.

**Completed Tasks:**
1. ‚úÖ Created migrations for all database tables:
   - `user_settings` - User preferences and last selected character
   - `character_data` - 24 character data types (archetype, career, skills, etc.)
   - `character_data` table supports all dataTypes from lists.js
   - 11 custom content tables (custom_archetypes, custom_armor, custom_weapons, etc.)
   - `vehicles` and `vehicle_data` - Vehicle management with 4 data types
2. ‚úÖ Created FeathersJS services for all data types:
   - Character data service (24 data types)
   - User settings service
   - 11 custom content services
   - Vehicles and vehicle data services
3. ‚úÖ All services support full CRUD operations
4. ‚úÖ Services include query filtering (user_id, data_type, name, read_access)
5. ‚úÖ API running on http://localhost:3030 with 20+ endpoints

**API Endpoints Created:**
Core:
- `/users` - User management
- `/characters` - Character list management
- `/character-data` - Character attributes (24 types)
- `/user-settings` - User preferences

Custom Content:
- `/custom-archetypes`, `/custom-archetype-talents`
- `/custom-armor`, `/custom-careers`, `/custom-gear`
- `/custom-motivations`, `/custom-settings`
- `/custom-skills`, `/custom-talents`
- `/custom-vehicles`, `/custom-weapons`

Vehicles:
- `/vehicles` - Vehicle management
- `/vehicle-data` - Vehicle attributes (4 types)

#### **Phase 3: React App Migration** ‚úÖ COMPLETED
Removed all Firebase code and connected React app to FeathersJS API.

**Completed Tasks:**
1. ‚úÖ Installed FeathersJS client packages (@feathersjs/client, axios, socket.io-client)
2. ‚úÖ Created FeathersJS client wrapper at `packages/emporium/src/api/client.ts`
3. ‚úÖ Removed Firebase from all 5 files:
   - `firestoreDB.js` - Stubbed out with no-ops
   - `actions.tsx` - Completely rewritten (450+ lines) to use Feathers API
   - `app.tsx` - Removed auth, using temp user ID
   - `User.tsx` - Replaced FirebaseUI with placeholder
   - `UserButton.tsx` - Removed auth, shows dev user
4. ‚úÖ Updated ALL Redux actions to use FeathersJS:
   - writeUser, changeData, loadData
   - loadCharacterList, addCharacter, deleteCharacter
   - importCharacter, importCustomData
   - addDataSet, removeDataSet, modifyDataSet, loadDataSets
   - Vehicle operations: loadDoc, changeDocData, changeFieldData
5. ‚úÖ Fixed webpack config to transpile FeathersJS ESM packages
6. ‚úÖ App compiles successfully (minor TS warnings remain)

**API Integration:**
- All 40+ Firebase operations migrated to FeathersJS
- Character CRUD operations functional
- Custom content operations ready
- Vehicle management integrated
- Real-time updates possible with Socket.io (commented out for now)

#### **Phase 4: Next Steps** üéØ TODO
1. ‚è≥ Implement FeathersJS authentication to replace temp user ID
2. ‚è≥ Test character creation and loading with actual data
3. ‚è≥ Implement real-time updates with Socket.io
4. ‚è≥ Add error handling and loading states
5. ‚è≥ Test custom content import/export
6. ‚è≥ Deploy API to production environment
   - Data models: Character, User, CustomData, etc.
4. ‚è≥ Define method signatures matching current Firebase operations:
   - User: `writeUser()`, `changeUser()`
   - Characters: `loadCharacterList()`, `addCharacter()`, `deleteCharacter()`
   - Data: `loadData()`, `changeData()`, `loadDataSets()`, `addDataSet()`
   - Vehicles: `loadDoc()`

#### **Phase 2: Stubbed Implementation**
Create stub implementations that return mock data or localStorage-based persistence.

**Tasks:**
1. ‚è≥ Implement `MockAuthService` with local auth state
2. ‚è≥ Implement `MockDataService` with localStorage or in-memory data
3. ‚è≥ Add TypeScript types for all data models
4. ‚è≥ Test stubs with Redux actions

#### **Phase 3: Redux Actions Migration**
Replace Firebase calls in `actions.tsx` with service layer calls.

**Tasks:**
1. ‚è≥ Inject service dependencies into action creators
2. ‚è≥ Replace `db.doc()`, `db.collection()` calls with service methods
3. ‚è≥ Replace `onSnapshot` with service subscription methods
4. ‚è≥ Update auth flow in `app.tsx`
5. ‚è≥ Replace FirebaseUI component in `User.tsx`
6. ‚è≥ Test application with stub services

#### **Phase 4: FeathersJS Backend Setup** (Future Work - Separate Project)
Create standalone FeathersJS API service.

**Backend Requirements:**
- Authentication service (JWT-based)
- User service
- Character service (CRUD + real-time updates)
- Custom content services (10 types)
- Postgres database with proper schema
- WebSocket support for real-time updates
- K8s deployment configuration

**Services to Create:**
- `/services/users`
- `/services/characters`
- `/services/character-data`
- `/services/custom-archetypes` (+ 9 more custom types)

#### **Phase 5: Real Service Implementation**
Implement actual API client services.

**Tasks:**
1. ‚è≥ Install FeathersJS client (`@feathersjs/client`)
2. ‚è≥ Implement `FeathersAuthService` using Feathers authentication
3. ‚è≥ Implement `FeathersDataService` using Feathers services
4. ‚è≥ Implement WebSocket-based real-time updates
5. ‚è≥ Add API error handling and retry logic
6. ‚è≥ Configure service URLs via environment variables
7. ‚è≥ Test with real backend

#### **Phase 6: Firebase Removal**
Remove all Firebase dependencies and code.

**Tasks:**
1. ‚è≥ Remove Firebase imports from codebase
2. ‚è≥ Delete `firestoreDB.js`
3. ‚è≥ Remove from package.json:
   - `firebase`
   - `@firebase/app`
   - `@firebase/firestore`
   - `react-firebaseui`
4. ‚è≥ Remove `firestore.rules` and `firebase.json`
5. ‚è≥ Update deployment scripts
6. ‚è≥ Run `npm audit` to verify vulnerability reduction

### Data Migration Strategy

**Option A: Export/Import**
1. Export all Firebase data to JSON
2. Transform to Postgres schema
3. Import via backend API or direct SQL

**Option B: Dual-Write Period**
1. Write to both Firebase and new backend temporarily
2. Verify data consistency
3. Switch read operations to new backend
4. Disable Firebase writes

**Recommendation:** Start with Option A for simplicity.

### Architecture Decisions

**Service Layer Pattern:**
```typescript
// Service abstraction
interface IDataService {
  loadCharacterList(userId: string): Promise<CharacterList>
  addCharacter(userId: string, character: Character): Promise<string>
  // ... more methods
}

// Redux action uses service
const loadCharacterList = (userId: string) => async (dispatch, getState, services) => {
  const characterList = await services.data.loadCharacterList(userId)
  dispatch({ type: 'CHARACTER_LIST_LOADED', payload: characterList })
}
```

**Real-time Updates:**
- Replace Firebase `onSnapshot` with FeathersJS real-time events
- Use `service.on('created')`, `service.on('updated')`, etc.
- Maintain Redux state update pattern

**Authentication:**
- Replace FirebaseUI with custom auth form or Auth0/Supabase
- Replace `firebase.auth().onAuthStateChanged()` with JWT token validation
- Store JWT in localStorage/sessionStorage

### Next Immediate Steps (ON HOLD - Focus on getting app running first)

1. ~~Create service layer directory structure~~
2. ~~Define TypeScript interfaces for all services~~
3. ~~Create mock/stub implementations~~
4. ~~Begin replacing Firebase calls in Redux actions~~

---

## COMPLETED: Convert to Yarn & Fix Build ‚úÖ SUCCESS!

## CURRENT PRIORITY: Migrate to Modern Stack (FeathersJS + Postgres + NextJS)

### Yarn Migration Steps
1. ‚úÖ Delete package-lock.json
2. ‚úÖ Configure yarn workspaces in package.json
3. ‚úÖ Run yarn install (with --ignore-engines flag)
4. ‚úÖ Verify build works with yarn - **BUILD SUCCEEDS!**
5. ‚è≥ Address TypeScript errors (non-blocking)

### Why Yarn?
- Better workspace support for monorepo (Nx setup)
- Potentially better dependency resolution
- May resolve peer dependency conflicts

### Build Configuration Changes Made
1. **Removed Nx Cloud**: Deleted `@nrwl/nx-cloud` from package.json
2. **Updated nx.json**: Changed runner from `@nrwl/nx-cloud` to `@nrwl/workspace/tasks-runners/default`
3. **Added @firebase/auth**: Installed v0.14.9 (compatible with old webpack)
4. **Downgraded Redux**:
   - redux: v5.0.1 ‚Üí v4.2.1
   - redux-thunk: v3.1.0 ‚Üí v2.4.2
   - react-redux: v9.1.2 ‚Üí v8.1.3
5. **Node.js workaround**: Using `NODE_OPTIONS=--openssl-legacy-provider` for old webpack compatibility

### Build Status ‚úÖ
**Build Command**: `yarn build emporium` or `yarn build`
**Dev Server Command**: `yarn dev`

**Dev Server**:
- Running at http://localhost:4200/
- Using @nrwl/web:dev-server (webpack-dev-server)
- Includes querystring polyfill for compatibility
- Custom webpack config at packages/emporium/webpack.config.js

**Output Files** (dist/packages/emporium/):
- main.js: 8.2MB
- vendor.js: 7.1M
- polyfills.js: 583K
- runtime.js: 6.2K
- styles.js: 11K

**Build Result**: SUCCESS (with TypeScript warnings)

### Remaining Warnings (Non-Blocking)
1. **TypeScript errors**: ~100+ type errors related to:
   - Redux dispatch types (thunk actions not properly typed)
   - reactstrap InputGroupAddon (removed in newer versions)
   - Input component type mismatches
2. **Peer dependency warnings**: Many packages have incorrect peer deps
   - react-firebaseui wants React 15-16 (we have 18)
   - Various @nrwl packages want matching versions

**Note**: These errors don't prevent the build from succeeding. The app builds and should run.

---

## NEW ARCHITECTURE PLAN

### Goals
1. ‚úÖ Remove Firebase (vulnerable, incompatible with React 18)
2. ‚è≥ Set up Postgres database in Docker
3. ‚è≥ Create FeathersJS API service layer
4. ‚è≥ Add NextJS for modern frontend with Server Actions
5. ‚è≥ Migrate existing React app to use new backend

### Architecture Overview

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Docker Compose                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Postgres 16 (Port 5432)                     ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  DB: genesys_emporium                        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  User: emporium / Password: emporium_dev     ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚ñ≤
                          ‚îÇ (Knex ORM)
                          ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          apps/api (FeathersJS + TypeScript)         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Service Layer                               ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Authentication                            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Users                                     ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Characters                                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Custom Content (10 types)                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                              ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  WebSocket support for real-time updates    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  Port: 3030                                  ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚ñ≤
                          ‚îÇ (Feathers Client)
                          ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         apps/web (NextJS 15 + Server Actions)       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Server Functions ‚Üí FeathersJS Client        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  Frontend ‚Üí React Components                 ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ  Existing React App (packages/emporium)             ‚îÇ
‚îÇ  Can also connect to FeathersJS API                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Progress

#### Phase 1: Infrastructure Setup ‚úÖ
- ‚úÖ Created `apps/` folder for new architecture
- ‚úÖ Updated yarn workspaces to include `apps/*`
- ‚úÖ Removed all Firebase dependencies:
  - `firebase`
  - `@firebase/app`
  - `@firebase/app-types`
  - `@firebase/auth`
  - `@firebase/firestore`
  - `react-firebaseui`
- ‚úÖ Created `docker-compose.yml` with Postgres 16
- ‚úÖ Created `.env` and `.env.example` with database configuration
- ‚úÖ Created `apps/api/package.json` with FeathersJS dependencies

#### Phase 2: FeathersJS API Setup ‚è≥ IN PROGRESS
- ‚úÖ Installed FeathersJS dependencies:
  - @feathersjs/feathers v5.0.29
  - @feathersjs/koa v5.0.29 (Koa framework)
  - @feathersjs/socketio v5.0.29 (real-time)
  - @feathersjs/authentication v5.0.29
  - @feathersjs/authentication-local v5.0.29
  - knex v3.1.0 (SQL query builder)
  - pg v8.13.1 (Postgres driver)
- ‚è≥ **NEXT**: Create TypeScript configuration
- ‚è≥ **NEXT**: Create basic FeathersJS app structure
- ‚è≥ **NEXT**: Configure Postgres connection
- ‚è≥ **NEXT**: Create initial services

#### Phase 3: Database Schema ‚è≥ PENDING
- ‚è≥ Create Knex migrations for:
  - users table
  - characters table
  - character_data table (JSONB for flexibility)
  - custom_content tables (10 types)
- ‚è≥ Seed initial data

#### Phase 4: NextJS Setup ‚è≥ PENDING
- ‚è≥ Create `apps/web` with NextJS 15
- ‚è≥ Install FeathersJS client
- ‚è≥ Create server functions that call FeathersJS
- ‚è≥ Set up TypeScript types

#### Phase 5: Service Layer Migration ‚è≥ PENDING
- ‚è≥ Create service interfaces matching Firebase operations
- ‚è≥ Implement FeathersJS services
- ‚è≥ Add real-time event listeners
- ‚è≥ Test with existing React app

### Environment Configuration

**Database (Docker)**:
```bash
docker-compose up -d    # Start Postgres
docker-compose down     # Stop Postgres
docker-compose logs postgres  # View logs
```

**Connection String**:
```
postgresql://emporium:emporium_dev@localhost:5432/genesys_emporium
```

**Ports**:
- Postgres: 5432
- FeathersJS API: 3030
- NextJS: 3000 (default)
- Existing React: 4200

### File Structure Created

```
/
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îî‚îÄ‚îÄ api/
‚îÇ       ‚îú‚îÄ‚îÄ package.json          ‚úÖ Created
‚îÇ       ‚îú‚îÄ‚îÄ tsconfig.json          ‚è≥ Next
‚îÇ       ‚îî‚îÄ‚îÄ src/
‚îÇ           ‚îú‚îÄ‚îÄ index.ts           ‚è≥ Next
‚îÇ           ‚îú‚îÄ‚îÄ services/          ‚è≥ Next
‚îÇ           ‚îî‚îÄ‚îÄ migrations/        ‚è≥ Next
‚îÇ
‚îú‚îÄ‚îÄ docker-compose.yml             ‚úÖ Created
‚îú‚îÄ‚îÄ .env                           ‚úÖ Created
‚îî‚îÄ‚îÄ .env.example                   ‚úÖ Created
```

### Next Immediate Steps

1. **Create FeathersJS App Structure**:
   ```bash
   # In apps/api/
   mkdir -p src/services
   # Create tsconfig.json
   # Create src/index.ts
   # Create src/app.ts
   ```

2. **Configure Database**:
   ```bash
   # Start Postgres
   docker-compose up -d

   # Create Knex configuration
   # Create initial migration
   ```

3. **Start API Server**:
   ```bash
   cd apps/api
   yarn dev    # Should start on port 3030
   ```

4. **Create NextJS App**:
   ```bash
   cd apps
   npx create-next-app@latest web --typescript --app --use-yarn
   ```

5. **Update Existing React App**:
   - Comment out Firebase imports
   - Create stub service layer
   - App should start without Firebase

### Benefits of New Architecture

‚úÖ **No Firebase Dependencies** - Removes security vulnerabilities
‚úÖ **Modern Stack** - FeathersJS v5 + NextJS 15 + Postgres 16
‚úÖ **Type Safety** - Full TypeScript across stack
‚úÖ **Real-time** - WebSocket support via FeathersJS
‚úÖ **Flexible Data** - JSONB in Postgres for complex character data
‚úÖ **Self-Hosted** - Full control, runs in Docker/K8s
‚úÖ **Service Layer** - Clean separation, testable
‚úÖ **Future-Proof** - Modern frameworks with active development

### Benefits of This Approach

‚úÖ Decouples application logic from Firebase
‚úÖ Makes codebase testable with mock services
‚úÖ Allows gradual migration without breaking changes
‚úÖ Can run locally with stubs before backend is ready
‚úÖ Aligns with existing FeathersJS knowledge
‚úÖ Full control over data and infrastructure
‚úÖ Resolves Firebase security vulnerabilities
‚úÖ Fixes react-firebaseui React 18 incompatibility
